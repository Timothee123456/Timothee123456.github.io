<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast WebRTC Screen Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-container { background: #1a1a1a; border-radius: 8px; overflow: hidden; aspect-ratio: 16 / 9; }
        video { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Screen Sharing (Manual Signaling)</h1>

        <div id="modeSelection" class="flex gap-4 mb-6">
            <button id="senderButton" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">I want to SHARE my screen</button>
            <button id="receiverButton" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">I want to VIEW a screen</button>
        </div>

        <div id="mainInterface" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h2 id="roleTitle" class="text-lg font-semibold mb-2 text-gray-700">Role: Undefined</h2>
                    <div class="video-container shadow-inner">
                        <video id="mainVideo" autoplay playsinline muted></video>
                    </div>
                    <div id="senderControls" class="mt-4 hidden space-x-2">
                        <button id="startSharingButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">1. Capture Screen</button>
                        <button id="createOfferButton" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 disabled:opacity-50" disabled>2. Create Offer</button>
                    </div>
                    <p id="statusMessage" class="mt-2 text-sm text-gray-600 font-medium">Waiting for interaction...</p>
                </div>

                <div class="flex flex-col">
                    <label for="combinedData" class="block text-sm font-medium text-gray-700 mb-1">Signaling Data:</label>
                    <textarea id="combinedData" class="flex-1 p-3 border rounded-lg font-mono text-xs bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Paste data here..."></textarea>
                    
                    <div class="mt-4 flex gap-2">
                        <button id="processDataButton" class="flex-1 bg-indigo-600 text-white font-bold py-2 rounded hover:bg-indigo-700">Process Pasted Data</button>
                        <button id="copyButton" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">Copy</button>
                    </div>
                </div>
            </div>
            
            <button id="resetButton" class="mt-6 text-red-500 text-sm hover:underline">Reset / Start Over</button>
        </div>
    </div>

    <script>
        const iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];
        let pc = null;
        let localStream = null;
        let isSender = false;

        const modeSelection = document.getElementById('modeSelection');
        const mainInterface = document.getElementById('mainInterface');
        const roleTitle = document.getElementById('roleTitle');
        const mainVideo = document.getElementById('mainVideo');
        const combinedDataTextarea = document.getElementById('combinedData');
        const statusMessage = document.getElementById('statusMessage');
        const senderControls = document.getElementById('senderControls');
        const startSharingButton = document.getElementById('startSharingButton');
        const createOfferButton = document.getElementById('createOfferButton');
        const processDataButton = document.getElementById('processDataButton');
        const copyButton = document.getElementById('copyButton');
        const resetButton = document.getElementById('resetButton');

        senderButton.onclick = () => setupMode(true);
        receiverButton.onclick = () => setupMode(false);
        resetButton.onclick = () => location.reload();

        function setupMode(sender) {
            isSender = sender;
            modeSelection.classList.add('hidden');
            mainInterface.classList.remove('hidden');
            roleTitle.innerText = isSender ? "Role: Sender" : "Role: Receiver";
            if (isSender) senderControls.classList.remove('hidden');
            statusMessage.innerText = isSender ? "Step 1: Capture your screen" : "Waiting for Offer from sender...";
        }

        function createPeerConnection() {
            pc = new RTCPeerConnection({ iceServers });
            
            pc.oniceconnectionstatechange = () => {
                statusMessage.innerText = `Connection: ${pc.iceConnectionState}`;
            };

            pc.ontrack = (event) => {
                if (!isSender) {
                    mainVideo.srcObject = event.streams[0];
                    statusMessage.innerText = "Connected! Stream active.";
                }
            };

            if (isSender && localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }
        }

        // The "Magic" function that waits for ICE but has a fast timeout
        async function waitForIceGathering(peerConnection) {
            return new Promise((resolve) => {
                if (peerConnection.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    const checkState = () => {
                        if (peerConnection.iceGatheringState === 'complete') {
                            peerConnection.removeEventListener('icegatheringstatechange', checkState);
                            resolve();
                        }
                    };
                    peerConnection.addEventListener('icegatheringstatechange', checkState);
                    // Force resolve after 2 seconds if gathering is slow
                    setTimeout(resolve, 2000);
                }
            });
        }

        startSharingButton.onclick = async () => {
            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                mainVideo.srcObject = localStream;
                createOfferButton.disabled = false;
                statusMessage.innerText = "Step 2: Create Offer";
            } catch (e) { alert("Capture failed"); }
        };

        createOfferButton.onclick = async () => {
            createOfferButton.disabled = true;
            statusMessage.innerText = "Generating Offer (max 2 seconds)...";
            
            createPeerConnection();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Wait for ICE (with our 2s timeout)
            await waitForIceGathering(pc);

            const payload = { sdp: pc.localDescription };
            combinedDataTextarea.value = JSON.stringify(payload);
            statusMessage.innerText = "Offer Ready! Copy and send to Receiver.";
        };

        processDataButton.onclick = async () => {
            const rawData = combinedDataTextarea.value.trim();
            if (!rawData) return;

            try {
                const data = JSON.parse(rawData);
                if (!pc) createPeerConnection();

                if (data.sdp.type === 'offer') {
                    statusMessage.innerText = "Offer received. Generating Answer...";
                    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    await waitForIceGathering(pc);
                    
                    combinedDataTextarea.value = JSON.stringify({ sdp: pc.localDescription });
                    statusMessage.innerText = "Answer Ready! Copy and send back to Sender.";
                } else if (data.sdp.type === 'answer') {
                    statusMessage.innerText = "Processing Answer...";
                    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                }
            } catch (e) {
                alert("Invalid data format.");
            }
        };

        copyButton.onclick = () => {
            combinedDataTextarea.select();
            document.execCommand('copy');
            copyButton.innerText = "Copied!";
            setTimeout(() => copyButton.innerText = "Copy", 2000);
        };
    </script>
</body>
</html>
