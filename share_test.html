<!DOCTYPE html>
<html lang="en">
<head>
    <title>Screen Sharing (Single Textbox)</title>
    <style>
        body { font-family: sans-serif; }
        video { width: 640px; height: 480px; border: 1px solid #ccc; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Screen Sharing (Single Textbox)</h1>

    <div id="modeSelection">
        <button id="senderButton">Sender</button>
        <button id="receiverButton">Receiver</button>
    </div>

    <div id="senderMode" class="hidden">
        <h2>Sender Mode</h2>
        <video id="localVideo" autoplay muted></video>
        <button id="startSharingButton">Start Sharing</button>
        <button id="callButton" disabled>Call</button>
        <button id="hangupButton" disabled>Hang Up</button>
    </div>

    <div id="receiverMode" class="hidden">
        <h2>Receiver Mode</h2>
        <video id="remoteVideo" autoplay></video>
    </div>

    <label for="combinedData">Combined Offer/Answer and ICE Candidates:</label><br>
    <textarea id="combinedData" rows="8" cols="50"></textarea><br>
    <button id="setData">Set Data</button>

    <script>
        const modeSelection = document.getElementById('modeSelection');
        const senderButton = document.getElementById('senderButton');
        const receiverButton = document.getElementById('receiverButton');
        const senderMode = document.getElementById('senderMode');
        const receiverMode = document.getElementById('receiverMode');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startSharingButton = document.getElementById('startSharingButton');
        const callButton = document.getElementById('callButton');
        const hangupButton = document.getElementById('hangupButton');
        const combinedDataTextarea = document.getElementById('combinedData');
        const setDataButton = document.getElementById('setData');

        let pc = null; // RTCPeerConnection
        let localStream = null;
        let iceCandidates = [];
        let isSender = false; // Track if the user is in sender mode

        // STUN server configuration (Google's public STUN server)
        const iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];

        senderButton.addEventListener('click', () => {
            isSender = true;
            senderMode.classList.remove('hidden');
            receiverMode.classList.add('hidden');
            modeSelection.classList.add('hidden');
        });

        receiverButton.addEventListener('click', () => {
            isSender = false;
            receiverMode.classList.remove('hidden');
            senderMode.classList.add('hidden');
            modeSelection.classList.add('hidden');
        });

        startSharingButton.addEventListener('click', startSharing);
        callButton.addEventListener('click', call);
        hangupButton.addEventListener('click', hangup);
        setDataButton.addEventListener('click', setData);

        async function startSharing() {
            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                localVideo.srcObject = localStream;
                callButton.disabled = false;
                startSharingButton.disabled = true;
            } catch (e) {
                console.error('Error getting media: ', e);
            }
        }

        async function call() {
            callButton.disabled = true;
            hangupButton.disabled = false;

            pc = new RTCPeerConnection({ iceServers: iceServers });

            // Collect ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    iceCandidates.push(event.candidate);
                } else {
                    console.log('All ICE candidates have been gathered.');
                    // Combine offer and ICE candidates
                    const offer = pc.localDescription.sdp;
                    const combined = offer + '\n---\n' + JSON.stringify(iceCandidates);
                    combinedDataTextarea.value = combined;
                }
            };

            pc.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

            } catch (e) {
                console.error('Error creating offer: ', e);
            }
        }

        async function setData() {
            const data = combinedDataTextarea.value;
            const parts = data.split('\n---\n');

            if (parts.length !== 2) {
                alert('Invalid data format.  Must contain offer/answer and ICE candidates separated by "---".');
                return;
            }

            const sdp = parts[0];
            const ice = parts[1];

            if (!pc) {
                pc = new RTCPeerConnection({ iceServers: iceServers });

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        iceCandidates.push(event.candidate);
                    } else {
                        console.log('All ICE candidates have been gathered (receiver).');
                        const answer = pc.localDescription.sdp;
                        const combined = answer + '\n---\n' + JSON.stringify(iceCandidates);
                        combinedDataTextarea.value = combined;
                    }
                };

                pc.ontrack = (event) => {
                    remoteVideo.srcObject = event.streams[0];
                };

                if (isSender && localStream) {
                    localStream.getTracks().forEach(track => {
                        pc.addTrack(track, localStream);
                    });
                }

            }

            try {
                if (pc.remoteDescription === null) {
                    await pc.setRemoteDescription({ type: 'offer', sdp: sdp });
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);


                }
                const iceCandidates = JSON.parse(ice);
                for (const candidate of iceCandidates) {
                    await pc.addIceCandidate(candidate);
                }
            } catch (e) {
                console.error('Error setting data: ', e);
                alert('Error setting data. Check the console for details.');
            }
        }

        function hangup() {
            if (pc) {
                pc.close();
                pc = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
                localStream = null;
            }

            callButton.disabled = false;
            hangupButton.disabled = true;
            startSharingButton.disabled = false;
            combinedDataTextarea.value = '';
            iceCandidates = [];
        }
    </script>
</body>
</html>
