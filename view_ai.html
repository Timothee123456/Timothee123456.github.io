<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tab Reader AI - Poe API</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 600px; margin-bottom: 20px; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        #previewContainer { width: 100%; max-width: 800px; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; display: none; margin-top: 10px; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #analyzeBtn { 
            width: 100%; padding: 15px; font-weight: bold; font-size: 16px;
            background: #6e45e2; color: white; border: none; border-radius: 6px; cursor: pointer;
            transition: transform 0.1s, background 0.3s;
        }
        #analyzeBtn:hover { background: #5835bc; transform: scale(1.02); }
        #response { width: 100%; max-width: 800px; background: #fff; padding: 15px; border-radius: 8px; margin-top: 20px; min-height: 50px; border-left: 5px solid #6e45e2; }
        .status { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>Poe Tab Reader</h2>
        <input type="password" id="apiKey" placeholder="Paste your Poe API Key here">
        <button id="start" style="width:100%; padding:10px; margin-bottom:10px;">Step 1: Share Tab</button>
        
        <textarea id="prompt" rows="3" placeholder="Ask something about the screen..."></textarea>
        
        <button id="analyzeBtn">Step 2: HOVER TO ANALYZE</button>
        <div id="status" class="status">Ready</div>
    </div>

    <div id="previewContainer">
        <video id="preview" autoplay muted></video>
    </div>

    <div id="response">AI Answer will appear here...</div>

    <canvas id="canvas" style="display:none;"></canvas>

    <!-- Import OpenAI SDK for Browser -->
    <script type="module">
        import OpenAI from "https://cdn.skypack.dev/openai";

        const video = document.getElementById('preview');
        const startBtn = document.getElementById('start');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const previewContainer = document.getElementById('previewContainer');
        const canvas = document.getElementById('canvas');
        const responseDiv = document.getElementById('response');
        const statusDiv = document.getElementById('status');

        let streamActive = false;

        // 1. Start Screen Sharing
        startBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { displaySurface: "browser" },
                    audio: false
                });
                video.srcObject = stream;
                previewContainer.style.display = 'block';
                streamActive = true;
                statusDiv.innerText = "Tab connected. Ready to analyze.";
            } catch (err) {
                alert("Permission denied or error: " + err.message);
            }
        };

        // 2. The Analysis Function
        async function runAnalysis() {
    const key = document.getElementById('apiKey').value;
    const userPrompt = document.getElementById('prompt').value || "What is visible?";

    if (!streamActive || !key) return;

    // 1. Capture frame
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const base64Image = canvas.toDataURL('image/jpeg', 0.6).split(',')[1]; // Get just the data part

    // 2. Use a CORS Proxy URL
    const proxyUrl = "https://corsproxy.io/?";
    const targetUrl = "https://api.poe.com/v1/chat/completions";

    try {
        const response = await fetch(proxyUrl + encodeURIComponent(targetUrl), {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${key}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: "gemini-2.0-flash",
                messages: [
                    {
                        role: "user",
                        content: [
                            { type: "text", text: userPrompt },
                            {
                                type: "image_url",
                                image_url: { url: `data:image/jpeg;base64,${base64Image}` }
                            }
                        ]
                    }
                ]
            })
        });

        const data = await response.json();
        responseDiv.innerText = data.choices[0].message.content;
    } catch (err) {
        responseDiv.innerText = "CORS Error: " + err.message;
    }
}

        // 3. Hover Trigger
        let debounceTimer;
        analyzeBtn.onmouseenter = () => {
            // Debounce to prevent accidental multiple triggers
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                runAnalysis();
            }, 300); 
        };
    </script>
</body>
</html>
